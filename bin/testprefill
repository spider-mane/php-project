#!/usr/bin/env php
<?php

ini_set('xdebug.var_display_max_depth', 10);
ini_set('xdebug.var_display_max_children', 256);
ini_set('xdebug.var_display_max_data', 1024);

################################################################################
# Config
################################################################################
$root = dirname(__DIR__, 1);
$testDir = $root . '/build/test-prefill';
$prefill = $testDir . '/bin/prefill';

$exclude = array_merge(
  [
    '.idea',
    '.project',
    '.vscode',
    'assets/build',
    'assets/dist',
    'assets/node_modules',
    'assets/package-lock.json',
    'build',
    'composer.lock',
    'vendor',
  ],
  glob("*.code-workspace"),
  glob("**/*.code-workspace"),
);

$answers = [
  'authorName' => 'Method Man',
  'authorEmail' => 'methodman@wutangfinancial.wu',
  'authorGithub' => 'fake-method-man-420',

  'packageName' => 'tical',
  'packageWebsite' => 'https://github.com/method-man-420/tical',
  'packageDescription' => "Straight from the brain, I'll be giving you the pain, anger! Coming from the 36th Chamber, bang!",

  'psr4Namespace' => "MethodMan\\Tical",
];

################################################################################
# Functions (as closures to avoid potential collisions with prefill script)
################################################################################
$copyContents = function (
  string $dir,
  string $copyDir,
  array $exclude = [],
  ?string $sub = null
) use (&$copyContents): void {
  $currentDir = $sub ?? $dir;

  $files = array_filter(scandir($currentDir), function ($file) {
    return !in_array($file, ['.', '..']);
  });

  foreach ($files as $file) {
    $file = "$currentDir/$file";
    $copy = $copyDir . '/' . str_replace("$dir", '', $file);

    if (in_array($file, $exclude)) {
      continue;
    }

    if (is_dir($file)) {
      mkdir($copy);
      $copyContents($dir, $copyDir, $exclude, $file);

      continue;
    }

    copy($file, $copy);
  }
};

################################################################################
# Run
################################################################################
$exclude = array_map(function ($file) use ($root) {
  return "$root/$file";
}, $exclude);

if (file_exists($testDir)) {
  shell_exec("chmod -R 777 $testDir && rm -rf -f $testDir");
}
mkdir($testDir);
$copyContents($root, $testDir, $exclude);

chdir($testDir);

// Limit exposure! With an immediately invoked closure.
(function ($__prefill__, $__answers__) {
  extract($__answers__);
  require $__prefill__;
})($prefill, $answers);
